name: Build 2DFaceX

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install git python3 make
        # Add GNU make to PATH
        echo "PATH=$(brew --prefix make)/libexec/gnubin:$PATH" >> "$GITHUB_ENV"
        # Verify make version
        make --version
    
    - name: Download and install Theos
      run: |
        mkdir -p "$GITHUB_WORKSPACE/theos"
        git clone --recursive https://github.com/theos/theos.git "$GITHUB_WORKSPACE/theos"
    
    - name: Set THEOS environment variable
      run: |
        echo "THEOS=$GITHUB_WORKSPACE/theos" >> "$GITHUB_ENV"
        # Ensure Theos is properly configured
        echo "Theos path: $GITHUB_WORKSPACE/theos"
        if [ -d "$GITHUB_WORKSPACE/theos/makefiles/package" ]; then
            ls -la "$GITHUB_WORKSPACE/theos/makefiles/package"
        else
            echo "Package directory not found"
        fi
    
    - name: Download iOS SDK
      run: |
        if [ ! -d "$GITHUB_WORKSPACE/theos/sdks" ]; then
            mkdir -p "$GITHUB_WORKSPACE/theos/sdks"
        fi
        # Clone the entire theos/sdks repository
        git clone https://github.com/theos/sdks.git "$GITHUB_WORKSPACE/sdks-repo"
        # Copy all SDKs to theos/sdks directory
        cp -r "$GITHUB_WORKSPACE/sdks-repo/"* "$GITHUB_WORKSPACE/theos/sdks/" 2>/dev/null || true
        # Clean up
        rm -rf "$GITHUB_WORKSPACE/sdks-repo"
        # Create a symlink for compatibility
        if [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.5.sdk" ]; then
            ln -sf "iPhoneOS16.5.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        elif [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.4.sdk" ]; then
            ln -sf "iPhoneOS16.4.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        elif [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.3.sdk" ]; then
            ln -sf "iPhoneOS16.3.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        fi
        # List available SDKs
        ls -la "$GITHUB_WORKSPACE/theos/sdks/"
    
    - name: Build 2DFaceX
      run: |
        # Check current directory and list files
        pwd
        ls -la
        # Navigate to 2DFaceX directory
        cd 2DFaceX
        pwd
        ls -la
        # Check Theos installation
        echo "Theos path: $GITHUB_WORKSPACE/theos"
        ls -la "$GITHUB_WORKSPACE/theos"
        # Add Theos to PATH
        export PATH="$PATH:$GITHUB_WORKSPACE/theos/bin"
        # Set deployment target
        export IPHONEOS_DEPLOYMENT_TARGET=15.0
        # Set THEOS environment variable explicitly
        export THEOS="$GITHUB_WORKSPACE/theos"
        # Check available make command
        which make
        make --version
        # Check Makefile content
        echo "Makefile content:"
        cat Makefile
        # Build with verbose output
        echo "Starting build..."
        # Clean previous builds
        make clean -v
        # Build package
        make package -v
        # Check if deb file was created
        echo "Build completed. Checking for deb files..."
        ls -la
        ls -la *.deb 2>/dev/null || echo "No deb files found in current directory"
        # Check in packages directory
        if [ -d "packages" ]; then
            echo "Checking in packages directory..."
            ls -la packages
            ls -la packages/*.deb 2>/dev/null || echo "No deb files found in packages directory"
        fi
        # Check in .theos directory
        if [ -d ".theos" ]; then
            echo "Checking in .theos directory..."
            ls -la .theos
            if [ -d ".theos/packages" ]; then
                echo "Checking in .theos/packages directory..."
                ls -la .theos/packages
                ls -la .theos/packages/*.deb 2>/dev/null || echo "No deb files found in .theos/packages directory"
            fi
        fi
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceX-deb
        path: 2DFaceX/*.deb
        retention-days: 7
