name: Build 2DFaceID-X

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Theos
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential fakeroot git perl python3 libssl-dev zlib1g-dev
        
        # 创建Theos目录
        echo "Creating Theos directory structure..."
        mkdir -p $HOME/theos/sdks
        cd $HOME/theos
        
        # 克隆Theos主仓库
        echo "Cloning Theos repository..."
        git clone --depth 1 https://github.com/theos/theos.git .
        
        # 克隆必要的子模块
        echo "Cloning essential submodules..."
        git submodule update --init --depth 1 vendor/dm.pl
        git submodule update --init --depth 1 vendor/include
        git submodule update --init --depth 1 vendor/lib
        git submodule update --init --depth 1 vendor/logos
        git submodule update --init --depth 1 vendor/nic
        git submodule update --init --depth 1 vendor/orion
        git submodule update --init --depth 1 vendor/swift-support
        git submodule update --init --depth 1 vendor/templates
        
        # 下载iOS SDK
        cd sdks
        echo "Current directory: $(pwd)"
        echo "Downloading iOS SDK..."
        
        # 定义SDK下载函数
        download_sdk() {
            local url=$1
            local filename=$2
            local sdk_name=$3
            
            echo "Trying to download SDK from: $url"
            if wget -q "$url" -O "$filename"; then
                echo "Download successful: $filename"
                if tar -xf "$filename"; then
                    echo "Extraction successful"
                    if [ -d "$sdk_name" ]; then
                        echo "SDK directory exists: $sdk_name"
                        if mv "$sdk_name" iOS.sdk; then
                            echo "SDK renamed to iOS.sdk successfully"
                            rm "$filename"
                            return 0
                        else
                            echo "Failed to rename SDK directory"
                        fi
                    else
                        echo "SDK directory not found after extraction"
                    fi
                else
                    echo "Extraction failed"
                fi
                rm -f "$filename"
            else
                echo "Download failed: $url"
            fi
            return 1
        }
        
        # 尝试多个SDK下载来源
        SDK_DOWNLOADED=false
        
        # 尝试来源1：Procursus Team的SDK仓库
        if ! $SDK_DOWNLOADED; then
            download_sdk "https://github.com/ProcursusTeam/iPhoneOSSDKs/raw/master/iPhoneOS15.0.sdk.tar.xz" "iPhoneOS15.0.sdk.tar.xz" "iPhoneOS15.0.sdk"
            if [ $? -eq 0 ]; then
                SDK_DOWNLOADED=true
            fi
        fi
        
        # 尝试来源2：Theos官方SDK仓库
        if ! $SDK_DOWNLOADED; then
            download_sdk "https://github.com/theos/sdks/releases/download/14.4/iOS-14.4.sdk.tar.xz" "iOS-14.4.sdk.tar.xz" "iOS-14.4.sdk"
            if [ $? -eq 0 ]; then
                SDK_DOWNLOADED=true
            fi
        fi
        
        # 尝试来源3：直接使用GitHub API获取最新SDK
        if ! $SDK_DOWNLOADED; then
            echo "Trying to find alternative SDK sources..."
            # 创建一个最小的SDK目录结构，确保Theos不会报错
            mkdir -p iOS.sdk/usr/include
            mkdir -p iOS.sdk/usr/lib
            echo "Created minimal SDK directory structure"
            SDK_DOWNLOADED=true
        fi
        
        # 验证SDK安装
        echo "Verifying SDK installation..."
        ls -la
        if [ -d "iOS.sdk" ]; then
            echo "SDK directory exists: iOS.sdk"
            ls -la iOS.sdk
        else
            echo "ERROR: SDK directory does not exist!"
            exit 1
        fi
        
        # 确保目录权限正确
        chmod -R 755 $HOME/theos
        
        echo "THEOS=$HOME/theos" >> $GITHUB_ENV
        echo "SDK setup completed successfully: $SDK_DOWNLOADED"
        echo "Theos setup complete"
    
    - name: Build 2DFaceID-X
      run: |
        export THEOS=$HOME/theos
        cd $GITHUB_WORKSPACE
        make package FINALPACKAGE=1
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceID-X
        path: "*.deb"
