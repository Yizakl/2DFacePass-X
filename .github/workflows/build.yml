name: Build 2DFaceX

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        brew install git python3
    
    - name: Download and install Theos
      run: |
        mkdir -p "$GITHUB_WORKSPACE/theos"
        git clone --recursive https://github.com/theos/theos.git "$GITHUB_WORKSPACE/theos"
    
    - name: Set THEOS environment variable
      run: |
        echo "THEOS=$GITHUB_WORKSPACE/theos" >> "$GITHUB_ENV"
        # Ensure Theos is properly configured
        echo "Theos path: $GITHUB_WORKSPACE/theos"
        if [ -d "$GITHUB_WORKSPACE/theos/makefiles/package" ]; then
            ls -la "$GITHUB_WORKSPACE/theos/makefiles/package"
        else
            echo "Package directory not found"
        fi
    
    - name: Download iOS SDK
      run: |
        if [ ! -d "$GITHUB_WORKSPACE/theos/sdks" ]; then
            mkdir -p "$GITHUB_WORKSPACE/theos/sdks"
        fi
        # Use theos/sdks repository to get iOS SDK
        git clone https://github.com/theos/sdks.git "$GITHUB_WORKSPACE/sdks-temp"
        cp -r "$GITHUB_WORKSPACE/sdks-temp/"* "$GITHUB_WORKSPACE/theos/sdks/"
        rm -rf "$GITHUB_WORKSPACE/sdks-temp"
    
    - name: Build 2DFaceX
      run: |
        cd 2DFaceX
        export PATH="$PATH:$GITHUB_WORKSPACE/theos/bin"
        make package THEOS_DEVICE_IP=127.0.0.1
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceX-deb
        path: 2DFaceX/*.deb
        retention-days: 7
