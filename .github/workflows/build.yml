name: Build 2DFaceX

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pywin32
    
    - name: Download and install Theos
      run: |
        mkdir -p $env:GITHUB_WORKSPACE\theos
        Invoke-WebRequest -Uri "https://github.com/theos/theos/releases/latest/download/theos.zip" -OutFile "theos.zip"
        Expand-Archive -Path "theos.zip" -DestinationPath "$env:GITHUB_WORKSPACE\theos"
        Remove-Item "theos.zip"
    
    - name: Set THEOS environment variable
      run: |
        echo "THEOS=$env:GITHUB_WORKSPACE\theos" >> $env:GITHUB_ENV
        echo "THEOS_PACKAGE_SCHEME=rootless" >> $env:GITHUB_ENV
    
    - name: Download iOS SDK
      run: |
        mkdir -p $env:GITHUB_WORKSPACE\theos\sdks
        Invoke-WebRequest -Uri "https://github.com/theos/sdks/releases/download/16.5/iPhoneOS16.5.sdk.tar.xz" -OutFile "iPhoneOS16.5.sdk.tar.xz"
        tar -xf "iPhoneOS16.5.sdk.tar.xz" -C "$env:GITHUB_WORKSPACE\theos\sdks"
        Remove-Item "iPhoneOS16.5.sdk.tar.xz"
    
    - name: Build 2DFaceX
      run: |
        cd 2DFaceX
        $env:PATH += ";$env:GITHUB_WORKSPACE\theos\bin"
        make package THEOS_DEVICE_IP=127.0.0.1 THEOS_PACKAGE_SCHEME=rootless
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: 2DFaceX-deb
        path: 2DFaceX/*.deb
        retention-days: 7
