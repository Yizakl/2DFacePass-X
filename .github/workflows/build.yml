name: Build 2DFaceX

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install git python3 make
        # Add GNU make to PATH
        echo "PATH=$(brew --prefix make)/libexec/gnubin:$PATH" >> "$GITHUB_ENV"
        # Verify make version
        make --version
    
    - name: Download and install Theos
      run: |
        mkdir -p "$GITHUB_WORKSPACE/theos"
        git clone --recursive https://github.com/theos/theos.git "$GITHUB_WORKSPACE/theos"
    
    - name: Set THEOS environment variable
      run: |
        echo "THEOS=$GITHUB_WORKSPACE/theos" >> "$GITHUB_ENV"
        # Ensure Theos is properly configured
        echo "Theos path: $GITHUB_WORKSPACE/theos"
        if [ -d "$GITHUB_WORKSPACE/theos/makefiles/package" ]; then
            ls -la "$GITHUB_WORKSPACE/theos/makefiles/package"
        else
            echo "Package directory not found"
        fi
    
    - name: Download iOS SDK
      run: |
        if [ ! -d "$GITHUB_WORKSPACE/theos/sdks" ]; then
            mkdir -p "$GITHUB_WORKSPACE/theos/sdks"
        fi
        # Clone the entire theos/sdks repository
        git clone https://github.com/theos/sdks.git "$GITHUB_WORKSPACE/sdks-repo"
        # Copy all SDKs to theos/sdks directory
        cp -r "$GITHUB_WORKSPACE/sdks-repo/"* "$GITHUB_WORKSPACE/theos/sdks/" 2>/dev/null || true
        # Clean up
        rm -rf "$GITHUB_WORKSPACE/sdks-repo"
        # Create a symlink for compatibility
        if [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.5.sdk" ]; then
            ln -sf "iPhoneOS16.5.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        elif [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.4.sdk" ]; then
            ln -sf "iPhoneOS16.4.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        elif [ -d "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.3.sdk" ]; then
            ln -sf "iPhoneOS16.3.sdk" "$GITHUB_WORKSPACE/theos/sdks/iPhoneOS.sdk"
        fi
        # List available SDKs
        ls -la "$GITHUB_WORKSPACE/theos/sdks/"
    
    - name: Build 2DFaceX
      run: |
        cd 2DFaceX
        export PATH="$PATH:$GITHUB_WORKSPACE/theos/bin"
        # Set deployment target to avoid arm64e warnings
        export IPHONEOS_DEPLOYMENT_TARGET=15.0
        # Build with verbose output to see details
        make package THEOS_DEVICE_IP=127.0.0.1 -v
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceX-deb
        path: 2DFaceX/*.deb
        retention-days: 7
