name: Build 2DFaceID-X

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up build environment
      run: sudo apt-get update && sudo apt-get install -y build-essential fakeroot git perl python3 libssl-dev zlib1g-dev dpkg-dev
    
    - name: Build DEB package
      run: |
        # Create directories
        mkdir -p deb/DEBIAN
        mkdir -p deb/Library/MobileSubstrate/DynamicLibraries
        mkdir -p deb/Library/PreferenceBundles
        mkdir -p deb/Library/PreferenceLoader/Preferences
        
        # Create control file
        cat > deb/DEBIAN/control << 'EOL'
Package: com.example.2dfaceid-x
Name: 2DFaceID-X
Version: 1.0.0
Architecture: iphoneos-arm
Description: Modern 2D face unlock tweak for iOS jailbroken devices
Maintainer: Your Name <your.email@example.com>
Depends: mobilesubstrate, preferenceloader
Section: Tweaks
Priority: optional
Homepage: https://github.com/yourusername/2DFaceID-X
EOL
        
        # Create postinst
        cat > deb/DEBIAN/postinst << 'EOL'
#!/bin/bash
chmod 755 /Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib
EOL
        chmod +x deb/DEBIAN/postinst
        
        # Create prerm
        cat > deb/DEBIAN/prerm << 'EOL'
#!/bin/bash
rm -f /Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib
EOL
        chmod +x deb/DEBIAN/prerm
        
        # Create placeholder files
        touch deb/Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib
        mkdir -p deb/Library/PreferenceBundles/2DFaceID-XPrefs.bundle
        touch deb/Library/PreferenceBundles/2DFaceID-XPrefs.bundle/2DFaceID-XPrefs
        
        # Create preference entry
        cat > deb/Library/PreferenceLoader/Preferences/2DFaceID-XPrefs.plist << 'EOL'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>cell</key>
	<string>PSLinkCell</string>
	<key>icon</key>
	<string>icon.png</string>
	<key>isController</key>
	<true/>
	<key>label</key>
	<string>2DFaceID-X</string>
	<key>bundle</key>
	<string>2DFaceID-XPrefs</string>
</dict>
</plist>
EOL
        
        # Build package
        dpkg-deb --build deb 2DFaceID-X.deb
    
    - name: Verify build
      run: ls -la *.deb && if [ -f *.deb ]; then echo "Build successful"; else exit 1; fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceID-X
        path: "*.deb"
