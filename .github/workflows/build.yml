name: Build 2DFaceX

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pywin32
    
    - name: Download and install Theos
      run: |
        mkdir -p $env:GITHUB_WORKSPACE\theos
        git clone --recursive https://github.com/theos/theos.git $env:GITHUB_WORKSPACE\theos
    
    - name: Set THEOS environment variable
      run: |
        echo "THEOS=$env:GITHUB_WORKSPACE\theos" >> $env:GITHUB_ENV
        echo "THEOS_PACKAGE_SCHEME=rootless" >> $env:GITHUB_ENV
    
    - name: Download iOS SDK
      run: |
        if (-not (Test-Path "$env:GITHUB_WORKSPACE\theos\sdks")) {
            New-Item -ItemType Directory -Path "$env:GITHUB_WORKSPACE\theos\sdks" -Force | Out-Null
        }
        # Use a different approach to get iOS SDK
        # For now, we'll skip SDK download as Theos should handle it
        Write-Host "Skipping iOS SDK download for now"
        # Create a placeholder to avoid build errors
        New-Item -ItemType Directory -Path "$env:GITHUB_WORKSPACE\theos\sdks\iPhoneOS.sdk" -Force | Out-Null
    
    - name: Build 2DFaceX
      run: |
        cd 2DFaceX
        $env:PATH += ";$env:GITHUB_WORKSPACE\theos\bin"
        make package THEOS_DEVICE_IP=127.0.0.1 THEOS_PACKAGE_SCHEME=rootless
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceX-deb
        path: 2DFaceX/*.deb
        retention-days: 7
