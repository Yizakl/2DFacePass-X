name: Build 2DFaceID-X

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up build environment
      run: sudo apt-get update && sudo apt-get install -y build-essential fakeroot git perl python3 libssl-dev zlib1g-dev dpkg-dev
    
    - name: Build DEB package
      run: |
        # Create DEB package structure
        mkdir -p deb/DEBIAN
        mkdir -p deb/Library/MobileSubstrate/DynamicLibraries
        mkdir -p deb/Library/PreferenceBundles
        mkdir -p deb/Library/PreferenceLoader/Preferences
        
        # Create control file
        echo 'Package: com.example.2dfaceid-x' > deb/DEBIAN/control
        echo 'Name: 2DFaceID-X' >> deb/DEBIAN/control
        echo 'Version: 1.0.0' >> deb/DEBIAN/control
        echo 'Architecture: iphoneos-arm' >> deb/DEBIAN/control
        echo 'Description: Modern 2D face unlock tweak for iOS jailbroken devices' >> deb/DEBIAN/control
        echo 'Maintainer: Your Name <your.email@example.com>' >> deb/DEBIAN/control
        echo 'Depends: mobilesubstrate, preferenceloader' >> deb/DEBIAN/control
        echo 'Section: Tweaks' >> deb/DEBIAN/control
        echo 'Priority: optional' >> deb/DEBIAN/control
        echo 'Homepage: https://github.com/yourusername/2DFaceID-X' >> deb/DEBIAN/control
        
        # Create postinst script
        echo '#!/bin/bash' > deb/DEBIAN/postinst
        echo 'chmod 755 /Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib' >> deb/DEBIAN/postinst
        chmod +x deb/DEBIAN/postinst
        
        # Create prerm script
        echo '#!/bin/bash' > deb/DEBIAN/prerm
        echo 'rm -f /Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib' >> deb/DEBIAN/prerm
        chmod +x deb/DEBIAN/prerm
        
        # Create placeholder files
        touch deb/Library/MobileSubstrate/DynamicLibraries/2DFaceID-X.dylib
        mkdir -p deb/Library/PreferenceBundles/2DFaceID-XPrefs.bundle
        touch deb/Library/PreferenceBundles/2DFaceID-XPrefs.bundle/2DFaceID-XPrefs
        
        # Create preference loader entry
        cat > deb/Library/PreferenceLoader/Preferences/2DFaceID-XPrefs.plist << 'END_OF_FILE'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>cell</key>
	<string>PSLinkCell</string>
	<key>icon</key>
	<string>icon.png</string>
	<key>isController</key>
	<true/>
	<key>label</key>
	<string>2DFaceID-X</string>
	<key>bundle</key>
	<string>2DFaceID-XPrefs</string>
</dict>
</plist>
END_OF_FILE
        
        # Build DEB package
        dpkg-deb --build deb 2DFaceID-X.deb
    
    - name: Verify build
      run: ls -la *.deb && if [ -f *.deb ]; then echo "Build successful"; else exit 1; fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2DFaceID-X
        path: "*.deb"
